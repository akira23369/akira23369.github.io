---
title: 12.XML数据管理类
date: 2025-03-07 13:17:28
toc: true
categories:
  - 数据
  - 数据持久化
  - XML

tags:
  - 数据
  - 数据持久化
  - XML
---
# 需求分析
目标：
- 提供公共的序列化和反序列化方法给外部
- 方便外部存储和获取数据

```cs
public class XmlDataMgr
{
    private static XmlDataMgr _instance = new XmlDataMgr();
    public static XmlDataMgr Instance => _instance;
    private XmlDataMgr() { }

    public void SaveData(object obj, string fileName)
    {

    }

    public void LoadData(Type type, string fileName)
    {

    }   
}
```


# 具体实现
```cs
public class XmlDataMgr
{
    private static XmlDataMgr _instance = new XmlDataMgr();
    public static XmlDataMgr Instance => _instance;
    private XmlDataMgr() { }

    public void SaveData(object obj, string fileName)
    {
        string path = $"{Application.persistentDataPath}/{fileName}.xml";
        using (StreamWriter writer = new StreamWriter(path))
        {
            XmlSerializer serializer = new XmlSerializer(obj.GetType());
            serializer.Serialize(writer, obj);
        }
    }

    public object LoadData(Type type, string fileName)
    {
        string path = $"{Application.persistentDataPath}/{fileName}.xml";
        if (!File.Exists(path))
        {
            path = $"{Application.streamingAssetsPath}/{fileName}.xml";
        }
        if (!File.Exists(path))
        {
            //如果根本不存在文件 两个路径都找过了
            //那么直接new 一个对象 返回给外部 无非 里面都是默认值
            return Activator.CreateInstance(type);
        }
        
        using (StreamReader reader = new StreamReader(path))
        {
            XmlSerializer serializer = new XmlSerializer(type);
            object obj = serializer.Deserialize(reader);
            return obj;
        }
    }   
}
```

测试类
```cs
public class TestData
{
    public string name;
    public int age;
    public TestData(string name, int age)
    {
        this.name = name;
        this.age = age;
    }
    public TestData() { }
}

public class Test : MonoBehaviour
{
    public SerializerDictionary<string, int> dic;
    private void Start()
    {
        // 创建测试数据对象
        TestData originalData = new TestData("John", 25);

        // 定义文件名
        string fileName = "testData";

        // 保存数据到 XML 文件
        XmlDataMgr.Instance.SaveData(originalData, fileName);
        Debug.Log("数据已保存到 XML 文件。");

        // 从 XML 文件加载数据
        TestData loadedData = (TestData)XmlDataMgr.Instance.LoadData(typeof(TestData), fileName);
        Debug.Log("数据已从 XML 文件加载。");

        // 验证加载的数据是否与原始数据一致
        if (loadedData != null && loadedData.name == originalData.name && loadedData.age == originalData.age)
        {
            Debug.Log("数据加载成功，内容一致。");
        }
        else
        {
            Debug.LogError("数据加载失败，内容不一致。");
        }
    }
}
```


生成的xml文件
```xml
<?xml version="1.0" encoding="utf-8"?>
<TestData xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <name>John</name>
  <age>25</age>
</TestData>
```


