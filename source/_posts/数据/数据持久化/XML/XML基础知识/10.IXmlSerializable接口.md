---
title: 10.IXmlSerializable接口
date: 2025-03-06 19:29:51
toc: true
categories:
  - 数据
  - 数据持久化
  - XML
  - XML基础知识

tags:
  - 数据
  - 数据持久化
  - XML
  - XML基础知识
---

# IXmlSerializable是什么
C# 的 `XmlSerializer` 接口提供了可拓展内容，可以让一些不能被序列化和反序列化的特殊类能够被处理。通过让特殊类继承 `IXmlSerializable` 接口并实现其中的方法，就能实现这一点。例如，字典就不能直接序列化，但可以通过自定义拓展让其序列化。

# 自定义序列化（实现IXmlSerializable接口）

## `ReadXml` 方法中 `XmlReader` 的常用属性和方法
**属性**
**`Name`** ：获取当前节点的名称。
**`NodeType`** ：获取当前节点的类型（如元素、文本、注释等）。
**`Value`**  ：获取当前节点的值。

**方法**
**`ReadStartElement`** ：读取当前元素的开始标记，并将读取器推进到下一个节点。
**`ReadElementContentAsString`** ：读取当前元素的内容并将其作为字符串返回，同时将读取器推进到下一个节点
**`ReadElementContentAsInt`** ：读取当前元素的内容并将其转换为整数返回，同时将读取器推进到下一个节点。
**`ReadEndElement`** ：读取当前元素的结束标记，并将读取器推进到下一个节点。
**`ReadToFollowing`** ：将读取器推进到具有指定名称的下一个元素。eg:`reader.ReadToFollowing("Person");`



## `WriteXml` 方法中 `XmlWriter` 的常用属性和方法
**属性**
**`Settings`** ：获取用于创建 `XmlWriter` 的 `XmlWriterSettings` 对象，可用于控制 XML 输出的格式，如缩进、编码等。

**方法**
**`WriteStartElement`** ：写入指定名称的元素开始标记。
**`WriteElementString`** ：写入包含指定值的元素。
**`WriteAttributeString`** ：写入包含指定值的属性。
**`WriteEndElement`** ：写入当前元素的结束标记。
**`WriteString`** ：写入指定的文本内容。
**`WriteWhitespace`** ：写入空白字符，可用于格式化 XML 输出。


## `writer.WriteAttributeString` 和 `reader[""]`
```cs
public class TestClass : IXmlSerializable
{
    public string Name { get; set; }
    public int Age { get; set; }

    public TestClass(string name, int age) => (Name, Age) = (name, age);

    public XmlSchema GetSchema() => null;

    public void ReadXml(XmlReader reader)
    {
        // 读写规则要同步
        this.Name = reader["这里填属性的名字"];
        this.Age = int.Parse(reader["Age要tostring"]);
    }

    public void WriteXml(XmlWriter writer)
    {
        writer.WriteAttributeString("这里填属性的名字", this.Name);
        writer.WriteAttributeString("Age要tostring", this.Age.ToString());
    }
    public TestClass() { }
}

```

序列化后如下
```xml
<?xml version="1.0" encoding="utf-8"?>
<TestClass 这里填属性的名字="名字" Age要tostring="18" /> <!-- 直接就在根节点上面写了-->
```

## reader.Read() 和 writer.WriteElementString
```cs
public class TestClass : IXmlSerializable
{
    public string Name { get; set; }
    public int Age { get; set; }

    public TestClass(string name, int age) => (Name, Age) = (name, age);

    public XmlSchema GetSchema() => null;

    public void ReadXml(XmlReader reader)
    {
        // 读写规则要同步
        //this.Name = reader["这里填属性的名字"];
        //this.Age = int.Parse(reader["Age要tostring"]);
        
        //// 读节点什么都没做是默认的根节点
        //reader.Read();      // 是读到根节点的第一个节点 即 <生成的节点名字>
        //reader.Read();      // 是读到第一个节点的值
        //this.Name = reader.Value;
        //reader.Read();      // 是读到第一个节点的结束标签
        //reader.Read();      // 是读到第二个节点的开始标签
        //reader.Read();      // 是读到第二个节点的值
        //this.Age = int.Parse(reader.Value); 

        // 或者这样
        while (reader.Read())
        {
            if (reader.NodeType == XmlNodeType.Element)
            {
                switch (reader.Name)
                {
                    case "生成的节点名字":
                        reader.Read();
                        this.Name = reader.Value;
                        break;
                    case "Age":
                        reader.Read();
                        this.Age = int.Parse(reader.Value);
                        break;
                }
            }
        }

    }

    public void WriteXml(XmlWriter writer)
    {
        //writer.WriteAttributeString("这里填属性的名字", this.Name);
        //writer.WriteAttributeString("Age要tostring", this.Age.ToString());

        writer.WriteElementString("生成的节点名字", this.Name);
        writer.WriteElementString("Age", this.Age.ToString());
    }
    public TestClass() { }
}
```
序列化后如下
```xml
<?xml version="1.0" encoding="utf-8"?>
<TestClass>
  <生成的节点名字>名字</生成的节点名字>
  <Age>18</Age>
</TestClass>
```

## writer.WriteStartElement 和 reader.ReadStartElement
```cs
public class TestClass : IXmlSerializable
{
    public string Name { get; set; }
    public int Age { get; set; }

    public TestClass(string name, int age) => (Name, Age) = (name, age);

    public XmlSchema GetSchema() => null;

    public void ReadXml(XmlReader reader)
    {
        // 读写规则要同步
        //this.Name = reader["这里填属性的名字"];
        //this.Age = int.Parse(reader["Age要tostring"]);

        //// 读节点什么都没做是默认的根节点
        //reader.Read();      // 是读到根节点的第一个节点 即
        //reader.Read();      // 是读到第一个节点的值
        //this.Name = reader.Value;
        //reader.Read();      // 是读到第一个节点的结束标签
        //reader.Read();      // 是读到第二个节点的开始标签
        //reader.Read();      // 是读到第二个节点的值
        //this.Age = int.Parse(reader.Value); 

        // 或者这样
        //while (reader.Read())
        //{
        //    if (reader.NodeType == XmlNodeType.Element)
        //    {
        //        switch (reader.Name)
        //        {
        //            case "生成的节点名字":
        //                reader.Read();
        //                this.Name = reader.Value;
        //                break;
        //            case "Age":
        //                reader.Read();
        //                this.Age = int.Parse(reader.Value);
        //                break;
        //        }
        //    }
        //}

        XmlSerializer s = new XmlSerializer(typeof(int));
        // 先跳过根节点
        reader.Read();
        reader.ReadStartElement("名字int");
        this.Age = int.Parse(s.Deserialize(reader).ToString());
        reader.ReadEndElement();

        XmlSerializer s2 = new XmlSerializer(typeof(string));
        reader.ReadStartElement("名字string");
        this.Name = s2.Deserialize(reader).ToString();
        reader.ReadEndElement();
    }

    public void WriteXml(XmlWriter writer)
    {
        //writer.WriteAttributeString("这里填属性的名字", this.Name);
        //writer.WriteAttributeString("Age要tostring", this.Age.ToString());

        //writer.WriteElementString("生成的节点名字", this.Name);
        //writer.WriteElementString("Age", this.Age.ToString());

        XmlSerializer s = new XmlSerializer(typeof(int));
        writer.WriteStartElement("名字int");
        s.Serialize(writer, this.Age);
        writer.WriteEndElement();


        XmlSerializer s2 = new XmlSerializer(typeof(string));
        writer.WriteStartElement("名字string");
        s2.Serialize(writer, this.Name);
        writer.WriteEndElement();
    }
    public TestClass() { }
}
```

序列化后如下
```xml
<?xml version="1.0" encoding="utf-8"?>
<TestClass>
  <名字int>
    <int>18</int>
  </名字int>
  <名字string>
    <string>名字</string>
  </名字string>
</TestClass>
```



## 其它示例
**目标XML格式**
```xml
<Player profile="hero">
  <Name>Arthur</Name>
  <Level>45</Level>
  <Inventory>
    <Item id="1">Excalibur</Item>
    <Item id="2">HolyGrail</Item>
  </Inventory>
</Player>
```
**对应的C#类实现**
```cs
public class PlayerData : IXmlSerializable
{
    public string ProfileType { get; set; }
    public string Name { get; set; }
    public int Level { get; set; }
    public List<InventoryItem> Inventory { get; set; } = new();

    public XmlSchema? GetSchema() => null;

    public void WriteXml(XmlWriter writer)
    {
        writer.WriteStartElement("Player");
        writer.WriteAttributeString("profile", ProfileType);
        
        writer.WriteElementString("Name", Name);
        writer.WriteElementString("Level", Level.ToString());
        
        writer.WriteStartElement("Inventory");
        foreach (var item in Inventory)
        {
            writer.WriteStartElement("Item");
            writer.WriteAttributeString("id", item.Id.ToString());
            writer.WriteString(item.Name);
            writer.WriteEndElement(); // Item
        }
        writer.WriteEndElement(); // Inventory
        
        writer.WriteEndElement(); // Player
    }

    public void ReadXml(XmlReader reader)
    {
        ProfileType = reader.GetAttribute("profile");
        reader.ReadStartElement("Player");
        
        Name = reader.ReadElementContentAsString("Name", "");
        Level = reader.ReadElementContentAsInt("Level", "");
        
        reader.ReadStartElement("Inventory");
        while (reader.NodeType == XmlNodeType.Element && reader.LocalName == "Item")
        {
            var item = new InventoryItem {
                Id = int.Parse(reader.GetAttribute("id")),
                Name = reader.ReadElementContentAsString()
            };
            Inventory.Add(item);
        }
        reader.ReadEndElement(); // Inventory
        
        reader.ReadEndElement(); // Player
    }
}

public class InventoryItem
{
    public int Id { get; set; }
    public string Name { get; set; }
}
```

