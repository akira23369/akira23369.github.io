---
title: 11.让Dictionary支持序列化和反序列化
date: 2025-03-07 12:25:45
toc: true
categories:
  - 数据
  - 数据持久化
  - XML

tags:
  - 数据
  - 数据持久化
  - XML
---

思考如何让Dictionary支持xml序列和反序列化？
我们没办法修改C#自带的类
那我们可以重写一个类 继承Dictionary 然后让这个类继承序列化拓展接口IXmlSerializable
实现里面的序列化和反序列化方法即可



自定义序列化Dictionary
```cs
public class SerializerDictionary<TKey, TValue> : Dictionary<TKey, TValue>, IXmlSerializable
{
    public XmlSchema GetSchema() => null;

    public void ReadXml(XmlReader reader)
    {
        XmlSerializer keySerializer = new XmlSerializer(typeof(TKey));
        XmlSerializer valueSerializer = new XmlSerializer(typeof(TValue));

        this.Clear();
        bool isEmpty = reader.IsEmptyElement;  // 检查是否是空元素

        reader.ReadStartElement();    // 跳过根节点， 读到根节点<root>下面的第一个节点

        if (isEmpty) return;

        while (reader.NodeType != XmlNodeType.EndElement)
        {
            // 反序列化键
            TKey key = (TKey)keySerializer.Deserialize(reader);

            // 反序列化值
            TValue value = (TValue)valueSerializer.Deserialize(reader);

            this.Add(key, value);
        }

        reader.ReadEndElement();  // 消费结束标签
    }

    public void WriteXml(XmlWriter writer)
    {
        XmlSerializer keySerializer = new XmlSerializer(typeof(TKey));
        XmlSerializer valueSerializer = new XmlSerializer(typeof(TValue));

        foreach (KeyValuePair<TKey, TValue> pair in this)
        {
            keySerializer.Serialize(writer, pair.Key);
            valueSerializer.Serialize(writer, pair.Value);  
        }
    }
}

```

测试类
```cs
public class Test : MonoBehaviour
{
    public SerializerDictionary<string, int> dic;
    private void Start()
    {
        string path = $"{Application.persistentDataPath}/Test.xml";
        print(path);

        dic = new SerializerDictionary<string, int>();
        dic["nihao"] = 1;
        dic["世界"] = 2;
        XmlSerializer serializer = new XmlSerializer(typeof(SerializerDictionary<string, int>));
        using (StreamWriter sw = new StreamWriter(path))
        {
            serializer.Serialize(sw, dic);
        }

        XmlSerializer serializer2 = new XmlSerializer(typeof(SerializerDictionary<string, int>));
        SerializerDictionary<string, int> newDic = new SerializerDictionary<string, int>();
        using (StreamReader r = new StreamReader(path))
        {
            newDic = serializer2.Deserialize(r) as SerializerDictionary<string, int>;
        }
    }
}
```

生成的xml文件
```xml
<?xml version="1.0" encoding="utf-8"?>
<SerializerDictionaryOfStringInt32>
  <string>nihao</string>
  <int>1</int>
  <string>世界</string>
  <int>2</int>
</SerializerDictionaryOfStringInt32>
```
